{% extends "base.html" %}
{% block content %}
<h2>Build #{{ build.id }} log</h2>
<p>
    Repository: <a href="/admin/repos/{{ build.repository_id }}">{{ build.repository.name if build.repository else build.repository_id }}</a><br>
    Target: {{ build.target.ref_type if build.target else '?' }} {{ build.ref_name }}
</p>
<div style="display:flex; gap:1rem; align-items:center;">
    <button type="button" id="copy-btn">Copy log to clipboard</button>
    <a class="button button-outline" href="/admin/repos/{{ build.repository_id }}">Back to repository</a>
</div>
<pre id="log-content" data-log-url="/admin/builds/{{ build.id }}/log.txt" style="max-height:70vh; overflow:auto; background:#111; color:#f5f5f5; padding:1rem; white-space:pre-wrap;">{{ log_content }}</pre>
<script>
(function () {
    const pre = document.getElementById('log-content');
    const copyBtn = document.getElementById('copy-btn');
    let interval;

    async function refreshLog() {
        const previousScroll = pre.scrollTop;
        const isPinnedToBottom =
            pre.scrollHeight - pre.clientHeight - previousScroll < 40;
        try {
            const resp = await fetch(pre.dataset.logUrl + '?t=' + Date.now());
            if (!resp.ok) return;
            const text = await resp.text();
            pre.textContent = text;
            if (isPinnedToBottom) {
                pre.scrollTop = pre.scrollHeight;
            } else {
                pre.scrollTop = previousScroll;
            }
        } catch (err) {
            console.warn('Unable to refresh log', err);
        }
    }

    interval = setInterval(refreshLog, 2000);
    refreshLog();

    copyBtn.addEventListener('click', async () => {
        try {
            await navigator.clipboard.writeText(pre.textContent);
            copyBtn.textContent = 'Copied!';
            setTimeout(() => (copyBtn.textContent = 'Copy log to clipboard'), 1500);
        } catch (err) {
            copyBtn.textContent = 'Failed to copy';
            setTimeout(() => (copyBtn.textContent = 'Copy log to clipboard'), 1500);
        }
    });
})();
</script>
{% endblock %}
