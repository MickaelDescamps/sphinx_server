{% extends "base.html" %}

{% block content %}
<section>
    <h2>User management</h2>
    {% if status == "created" %}
        <p style="color:#27ae60;">User created.</p>
    {% elif status == "role-updated" %}
        <p style="color:#27ae60;">User role updated.</p>
    {% elif status == "password-reset" %}
        <p style="color:#27ae60;">Password reset.</p>
    {% endif %}
    {% if error %}
        <p style="color:#c0392b;">{{ error }}</p>
    {% endif %}
    {% if ldap_managed %}
        <p style="color:#2980b9;">Accounts are managed by the LDAP server and cannot be changed in this application.</p>
    {% endif %}
</section>

<section>
    <h3>{% if ldap_managed %}Authorized LDAP users{% else %}Existing users{% endif %}</h3>
    {% if ldap_managed %}
        {% if ldap_users %}
            <table>
                <thead>
                    <tr>
                        <th>Identifier</th>
                        <th>Role</th>
                        <th>LDAP group</th>
                        <th>Directory value</th>
                    </tr>
                </thead>
                <tbody>
                {% for user in ldap_users %}
                    <tr>
                        <td>{{ user.identifier }}</td>
                        <td>{{ user.role.value }}</td>
                        <td>{{ user.group_dn }}</td>
                        <td>{{ user.dn or user.raw_value }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No LDAP groups returned members. Confirm your SPHINX_SERVER_LDAP_* group settings.</p>
        {% endif %}
    {% else %}
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Last login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.role.value }}</td>
                    <td>{{ user.full_name or "-" }}</td>
                    <td>{{ user.email or "-" }}</td>
                    <td>{{ user.last_login_at or "-" }}</td>
                    <td>
                        <form method="post" action="/admin/users/{{ user.id }}/role" style="margin-bottom:0.5rem;">
                            <fieldset>
                                <select name="role">
                                    {% for role in roles %}
                                        <option value="{{ role.value }}" {% if role == user.role %}selected{% endif %}>{{ role.value|capitalize }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit">Update role</button>
                            </fieldset>
                        </form>
                        <form method="post" action="/admin/users/{{ user.id }}/reset-password">
                            <fieldset>
                                <input type="password" name="password" placeholder="New password" minlength="8" required>
                                <button type="submit">Reset password</button>
                            </fieldset>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
</section>

{% if not ldap_managed %}
    <section>
        <h3>Create user</h3>
        <form method="post" action="/admin/users">
            <fieldset>
                <label for="username">Username</label>
                <input id="username" name="username" type="text" required>

                <label for="full_name">Full name</label>
                <input id="full_name" name="full_name" type="text">

                <label for="email">Email</label>
                <input id="email" name="email" type="email">

                <label for="role">Role</label>
                <select id="role" name="role">
                    {% for role in roles %}
                        <option value="{{ role.value }}">{{ role.value|capitalize }}</option>
                    {% endfor %}
                </select>

                <label for="password">Password</label>
                <input id="password" name="password" type="password" minlength="8" required>

                <button type="submit">Create user</button>
            </fieldset>
        </form>
    </section>
{% endif %}
{% endblock %}
